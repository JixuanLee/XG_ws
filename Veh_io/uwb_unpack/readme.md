# 功能包介绍

## 0.第一次运行程序需要对[chmod_usb_anchor0.sh](launch/chmod_usb_anchor0.sh)授权!!
0.1 用下述命令打开本功能包的launch文件夹中的chmod_usb_anchor0.sh文件，将其中的密码设置为本机的开机密码。 
`gedit src/uwb_unpack/launch/chmod_usb_anchor0.sh`   
0.2 给文件进行授权,输入  
`sudo chmod 777 src/uwb_unpack/launch/chmod_usb_anchor0.sh`

## 1.代码介绍
本功能包用于解包uwb数据,发布uwb硬件定位出的tag坐标(/uwb)和硬件定位出的tag到四个基站的距离(/uwb_raw).具体内容参考 [topiclist.md](topiclist.md).  
根据项目需求,只对基站0发出的数据进行解包,遵循的协议是NLink_LinkTrack_Anchor_Frame0.其中,由于只有一个标签,因此只对block0进行了数据读取,后续可根据需求自行改动.  
目前由于anchor的布局限制，需要对anchor测出的tag坐标中的x坐标和z坐标进行取反。但由于四个同平面基站数学上无法解出目标是在该平面的上方还是下方，因此是否对z坐标进行取反不影响效果，且本项目中不需要用到z值。值得一提的是，默认的z坐标取负值，在本项目代码中经过取反后得到的z坐标也就是负值。

## 2.硬件介绍
本功能包利用的是[LoopNoop公司](https://www.nooploop.com/)的uwb产品,具体型号为LTP-B基站4个,和LTP-BT2标签1个. 
### 2.1 基站
基站在使用过程中,尽可能保持周围空旷,否则会影响精确度.安装时放置在远离地面的位置,至少离地50cm,天线应竖直向上.
### 2.2 标签
标签在使用过程中,也要尽可能保持周围空旷,测试阶段如果是人手拿标签，则建议拿住标签下半部分将标签举过头顶 进行测试来尽量减小遮挡.
### 2.3 标定
可以进行手动标定,也可以利用上位机的自动标定,主要目的是得到基站0和基站1之间的距离gap.  
目前四个基站的话，建议选择自动标定，更为方便。目前没有写手动计算的代码(即利用tag到四个基站的原始数据得到目标的xyz值，只有利用两个基站到的版本)。  
目前四个基站位置和建立的坐标系以A0为原点,右手坐标系，具体示意如下所示:  

                    b____车头____d  
     y <---------A1----------------A0
                                    |  
                                    |  
                                    |  
                 A2----------------A3    
                                    |    
                                    |  
                                    V  x  
因此根据此坐标系，需要将x坐标和z坐标进行取反操作。
#### 2.3.1 自动标定
两个基站：如果是自动标定的话,上位机自动标定至少需要3个基站才能进行,且第三个基站A3才是图中A1的位置,因此可以先将A3放置在A1处进行标定,在结束标定后,利用上位机重新将基站A3的id设定为A1即可.然后将gap设定为该值.  
四个基站：将四个基站按照坐标位置对应摆放，处于同一水平面(否则会降低定位精度)，连接上位机自动标定即可。标定到结果将写入A0，以后每次使用都将以标定到结果进行解算，最终得到tag的xyz坐标值。
#### 2.3.2 手动标定
两个基站：先将基站A0和基站A1固定,手动测出A0与A1之间的距离,然后将gap设定为该值.
 
## 3.代码运行
该功能包已被集成在主目录下,如果要单独运行本功能包,请运行  
`source ./devel/setup.bash`  
`roslaunch uwb_unpack uwb_unpack_start.launch`